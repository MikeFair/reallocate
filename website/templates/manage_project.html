{% extends 'theme/base.html' %}

{% block extra_css %}
    <style>
        #updates {
        }
        .update, .post-update {
            padding: 0px 0px 10px 0px;
            border-bottom: 1px solid #ededed;
            margin-bottom: 15px;
        }
        .update:last-child {
            border: none;
        }
        .update-username {
            color: black;
        }
        .update-opp-name {
            color: #808080;
        }
        .update-text {
            color: #808080;
        }
        .update-media img {
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
    
<div class="container" id="manage-project">

    <div class="row">
    
        <div class="col-7">

            <form method="post" id="edit-project">

                <input type="hidden" name="id" value="{{ project.id }}" />
                <p id="project-name"><i class="icon-pencil"></i><input readonly="readonly" name="name" value="{{ project.name }}" /></p>
                <p id="project-short-desc"><i class="icon-pencil"></i><input readonly="readonly" name="short_desc" value="{{ project.short_desc|safe }}" /></p>

                <div id="desc-modal" class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 id="desc-modal-label" class="modal-title">Project description</h4>
                            </div>
                            <div class="modal-body">
                                <textarea class="form-control" name="description" id="project-desc">{{ project.description }}</textarea>
                                <div class="pull-right modal-buttons">
                                    <button class="btn btn-default" data-dismiss="modal">Close</button>
                                    <button class="btn btn-primary" onclick="$(this).parents('form').submit();" data-dismiss="modal">Save changes</button>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <p><a href="#desc-modal" role="button" class="btn btn-default" data-toggle="modal">Edit full description</a></p>      

            </form>
        </div>

        <div class="col-offset-1 col-4" id="org">
            <fieldset>
                <h4>{{ project.organization.name }}</h4>
                <p>{{ project.organization.country }}</p>
                <p>{{ project.organization.org_mission }}</p>
            </fieldset>
        </div>
        
    </div>

    <div class="row wall">

        <div class="col-7">
            <div id="updates">
                <h4>Updates</h4>
                {% include 'includes/post-update.html' %}
                {% for update in updates %}
                <div class="update">
                    {% if update.media_url %}
                    <div class="update-media"><img src="{{ update.media_url }}"></div>
                    {% endif %}
                    <p class="update-date">{{ update.date_created.date }}</p>
                    <p class="update-text pre">{{ update.text }}</p>
                    {% if update.created_by.get_profile.media_url %}                    
                    <img class="update-avatar" src="{{ update.created_by.get_profile.media_url }}" />
                    {% endif %}
                    <a class="update-username" href="/profile/{{ update.created_by.id }}">
                    {{ update.created_by.first_name }} {{ update.created_by.last_name }}
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-offset-1 col-4">

            <h4>Opportunity Engagement</h4>
            {% for opportunity in opportunities %}
                {% include "includes/opportunity-pane-small.html" %}
                <ul>
                {% for engagement in engagements %}
                    {% ifequal opportunity engagement.opportunity %}
                    <li><a href="/profile/{{ engagement.user.id }}">{{ engagement.user.first_name }} {{ engagement.user.last_name }}</a>
                    {% if engagement.status == "Pending" %} (Pending){% endif %}</li>
                    {% endifequal %}
                {% endfor %}
                </ul>
            {% endfor %}

        </div>

    </div>


</div>


{% endblock %}

{% block bottomscript %}

<script>

    $('#edit-project input').on('click', function() {
        $(this).removeAttr('readonly');
    });
    $('#edit-project input').on('blur', function() {
        $(this).attr('readonly', 'readonly');
        if ($(this).data('changed')) {
            $(this).parents('form').submit();
        }
    });
    $('#edit-project input').on('change', function() {
        $(this).data('changed', true);  
    });
    $('#edit-project').on('submit', function(e) {

        e.preventDefault();

        $.ajax({
            url: '/ajax/update-project',
            method: 'POST',
            data: $(this).serialize(),
            success: function(res) {
                console.log(res)
            },
            error: function(res) {
                console.log(res)
            }
        });

    });

</script>

{% endblock %}